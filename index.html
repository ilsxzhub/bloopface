<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BloopBot - BROBOTS</title>
<style>
  body { background:#000; color:#8fdcff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; margin:0; gap:18px; }
  .eye-container { display:flex; gap:80px; align-items:center; }
  .eye { width:120px; height:120px; background:#00f; border-radius:50%; box-shadow:0 0 20px #00f,0 0 40px #00f; position:relative; overflow:hidden; transition: box-shadow 0.2s, background 0.2s; }
  .eyelid { position:absolute; top:0; left:0; width:100%; height:100%; background:#000; transform:scaleY(0); transform-origin:top; transition:transform .14s ease-in-out; }
  .eye.blink .eyelid { transform:scaleY(1); }
  .eye.thinking { animation:thinkPulse .9s infinite; }
  .eye.speaking { animation: speakPulse 0.4s infinite; }
  @keyframes thinkPulse { 0%{ transform:scale(1); }50%{ transform:scale(1.03); }100%{ transform:scale(1); } }
  @keyframes speakPulse { 0%{ transform: scale(1); } 25%{ transform: scale(1.05); } 50%{ transform: scale(1.1); } 75%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
  .panel { width:min(920px,92vw); background:rgba(10,20,30,.6); border-radius:10px; padding:12px; display:flex; justify-content:space-between; gap:12px; align-items:center; border:1px solid rgba(100,200,255,.08); }
  .status{ font-weight:600; color:#bfefff; } .transcript{ color:#dff6ff; opacity:.9; font-size:.92rem; }
  #startBloop { padding:18px 36px; font-size:20px; border-radius:14px; background:#00aaff; border:0; color:white; box-shadow:0 0 20px #00aaff; cursor:pointer; }
  button.small { padding:8px 12px; border-radius:8px; background:#012; color:#9ef; border:1px solid rgba(160,240,255,0.08); cursor:pointer; }
</style>
</head>
<body>

<button id="startBloop">ðŸ”µ Start Bloop</button>

<div class="eye-container" aria-hidden="true">
  <div class="eye" id="eye1"><div class="eyelid"></div></div>
  <div class="eye" id="eye2"><div class="eyelid"></div></div>
</div>

<div class="panel">
  <div>
    <div class="status" id="status">Status: <strong id="statusText">Waiting to start</strong></div>
    <div class="transcript" id="transcript">Transcript: â€”</div>
  </div>
  <button id="testAI" class="small">Test AI</button>
</div>

<script>
/* ----------------- UI HELPERS ----------------- */
const statusText = document.getElementById('statusText');
const transcriptEl = document.getElementById('transcript');
function setStatus(s){ statusText.textContent = s; }

function blink() {
  document.querySelectorAll('.eye').forEach(e => e.classList.add('blink'));
  setTimeout(()=>document.querySelectorAll('.eye').forEach(e => e.classList.remove('blink')), 180);
}

function thinking(on){
  document.querySelectorAll('.eye').forEach(e => e.classList.toggle('thinking', !!on));
}

function reactEyesToKeyword(keyword){
  const eyes = document.querySelectorAll('.eye');
  if(keyword.includes("glow")){
    eyes.forEach(e => e.style.boxShadow="0 0 40px #0ff,0 0 80px #0ff");
  } else if(keyword.includes("dance")){
    eyes.forEach(e => e.style.transform="rotate(10deg)");
    setTimeout(()=>eyes.forEach(e => e.style.transform="rotate(0deg)"),400);
  } else {
    eyes.forEach(e => e.style.boxShadow="0 0 20px #00f,0 0 40px #00f");
  }
}

/* ----------------- BLOOPSPEAK (BEEP TTS) ----------------- */
async function bloopSpeak(text){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let t=0;
  for(const c of text){
    if(c===' '){ t+=0.09; continue; }
    const f = 450+(c.charCodeAt(0)%240);
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.frequency.value=f;
    g.gain.setValueAtTime(0.12,ctx.currentTime+t);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.08);
    osc.connect(g).connect(ctx.destination);
    osc.start(ctx.currentTime+t);
    osc.stop(ctx.currentTime+t+0.08);

    if(Math.random() < 0.3) blink(); // blink randomly while speaking
    t+=0.085;
  }
  await new Promise(r=>setTimeout(r,Math.max(200,t*1000)));
}

/* --------------- TTS SELECTOR ---------------- */
async function speakText(text){
  reactEyesToKeyword(text.toLowerCase());
  document.querySelectorAll('.eye').forEach(e => e.classList.add('speaking'));

  if('speechSynthesis' in window && speechSynthesis.getVoices().length>0){
    return new Promise(res=>{
      try{ recognition.stop(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      u.rate=1; u.pitch=1;
      u.onend=()=>{
        document.querySelectorAll('.eye').forEach(e => e.classList.remove('speaking'));
        setTimeout(()=>tryStartRecognition(),200); 
        res();
      };
      speechSynthesis.speak(u);
      setStatus("Speaking...");
    });
  } else {
    await bloopSpeak(text);
    document.querySelectorAll('.eye').forEach(e => e.classList.remove('speaking'));
    setTimeout(()=>tryStartRecognition(),150);
  }
}

/* --------------- ENHANCED FALLBACK AI ----------------- */
const conversationHistory = [];
const MAX_HISTORY = 5;

function fallbackAI(prompt) {
  if (!prompt.trim()) return "Say something, Iâ€™m listening!";

  conversationHistory.push(prompt);
  if (conversationHistory.length > MAX_HISTORY) conversationHistory.shift();

  const lower = prompt.toLowerCase();

  const personality = [
    "Bloop is glowing happily! ðŸ’™",
    "Your neon-tech buddy is here! âš¡",
    "I see you, shining human! ðŸŒŸ",
    "BloopBotâ€™s sensors are tingling... ðŸ‘€",
    "Processingâ€¦ but make it stylish. ðŸ˜Ž"
  ];

  if (lower.includes("how are you")) return personality[Math.floor(Math.random() * personality.length)];
  if (lower.includes("your name")) return "Iâ€™m Bloop, your neon-tech buddy!";
  if (lower.includes("joke")) return "Why did the neon light break up with the lamp? It just needed some space! ðŸ˜†";
  if (lower.includes("dance")) return "ðŸ’ƒ BloopBot is wiggling its neon circuits!";
  if (lower.includes("glow")) return "âœ¨ Eyes glowing to maximum brightness!";

  if (conversationHistory.length > 1) {
    const last = conversationHistory[conversationHistory.length - 2];
    if (last.toLowerCase().includes("hello") || last.toLowerCase().includes("hi")) {
      return "Hey again! BloopBotâ€™s eyes are twinkling just for you! ðŸ’™";
    }
  }

  const responses = [
    "You said: " + prompt,
    "Hmmâ€¦ interesting! " + prompt,
    "Iâ€™m thinkingâ€¦ " + prompt,
    "Bloop heard: " + prompt,
    "Processing your wordsâ€¦ " + prompt
  ];

  return responses[Math.floor(Math.random() * responses.length)];
}

/* ----------------- ASK AI ----------------- */
async function askAI(prompt){
  setStatus("Thinking...");
  thinking(true);
  try{
    if(GN_supported && GN_model){
      const gen = await GN_model.generate({ input: prompt });
      let txt =
        gen?.outputText ||
        gen?.output?.[0]?.content?.[0]?.text ||
        gen?.output?.[0]?.text ||
        "[Unknown GN output] " + prompt;
      return txt;
    }
    return fallbackAI(prompt);
  } catch(e){
    return "I had trouble thinking.";
  } finally {
    thinking(false);
    setStatus('Idle â€” waiting for "bloop"');
  }
}

/* --------------- GEMINI NANO SETUP ----------------- */
let GN_model = null;
let GN_supported = false;

async function loadGeminiNanoIfAvailable(){
  if('ai' in window && typeof ai.getModel === 'function'){
    try{
      setStatus("Loading Gemini Nano...");
      GN_model = await ai.getModel("text-lite");
      GN_supported = true;
      setStatus("Gemini Nano ready");
    } catch(e){
      GN_supported = false;
      setStatus("Gemini Nano not available");
    }
  } else {
    GN_supported = false;
    setStatus("No Gemini Nano support");
  }
}

/* ----------------- SPEECH RECOGNITION ----------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

function tryStartRecognition(){
  try{ if(recognition) recognition.start(); } catch(e){}
  setStatus('Listening for "bloop"...');
}

if(!SpeechRecognition){
  setStatus("No speech recognition");
} else {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.lang = "en-US";
  recognition.interimResults = false;

  let awaitingCommand = false;
  const WAKE = "bloop";

  recognition.onend = ()=>setTimeout(()=>tryStartRecognition(),200);
  recognition.onerror = ()=>setTimeout(()=>tryStartRecognition(),400);

  recognition.onresult = (ev)=>{
    const text = ev.results[ev.results.length-1][0].transcript.trim();
    transcriptEl.textContent = "Transcript: " + text;
    const lower = text.toLowerCase();

    if(awaitingCommand){
      awaitingCommand=false;
      (async()=>{ const r=await askAI(text); await speakText(r); })();
      return;
    }

    if(lower.includes(WAKE)){
      blink();
      const after = lower.replace(/.*bloop[\s,!?]*/,"").trim();
      if(after){
        (async()=>{ const r=await askAI(after); await speakText(r); })();
      } else {
        awaitingCommand=true;
        speakText("Yes? I'm listening.");
      }
    }
  };
}

/* --------------- START BUTTON ---------------- */
document.getElementById("startBloop").onclick = async ()=>{
  document.getElementById("startBloop").style.display="none";
  try{
    await navigator.mediaDevices.getUserMedia({ audio:true });
  } catch(e){
    setStatus("Mic blocked");
    return;
  }
  await loadGeminiNanoIfAvailable();
  tryStartRecognition();
};

/* test button */
document.getElementById("testAI").onclick = async ()=>{
  const ans = await askAI("Say hello like a robot.");
  await speakText(ans);
};

/* random blink */
setInterval(()=>blink(), Math.random()*3000+2000);
</script>

</body>
</html>

